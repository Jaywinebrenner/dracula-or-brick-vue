(function(e){var c={method:"GET",contentType:"json",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",animateDropdown:true,tokenLimit:null,tokenDelimiter:",",preventDuplicates:false,tokenValue:"id",prePopulate:null,processPrePopulate:false,idPrefix:"token-input-",resultsFormatter:function(g){return"<li>"+g[this.propertyToSearch]+"</li>"},tokenFormatter:function(g){return"<li><p title='"+g[this.propertyToSearch]+"'>"+g[this.propertyToSearch]+"</p></li>"},onResult:null,onAdd:null,onDelete:null,onReady:null};var f={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"};var d={BEFORE:0,AFTER:1,END:2};var a={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188};var b={init:function(g,h){var i=e.extend({},c,h||{});return this.each(function(){e(this).data("tokenInputObject",new e.TokenList(this,g,i))})},clear:function(){this.data("tokenInputObject").clear();return this},add:function(g){this.data("tokenInputObject").add(g);return this},remove:function(g){this.data("tokenInputObject").remove(g);return this},get:function(){return this.data("tokenInputObject").getTokens()}};e.fn.tokenInput=function(g){if(b[g]){return b[g].apply(this,Array.prototype.slice.call(arguments,1))}else{return b.init.apply(this,arguments)}};e.TokenList=function(j,t,S){if(e.type(t)==="string"||e.type(t)==="function"){S.url=t;var n=y();if(S.crossDomain===undefined){if(n.indexOf("://")===-1){S.crossDomain=false}else{S.crossDomain=(location.href.split(/\/+/g)[1]!==n.split(/\/+/g)[1])}}}else{if(typeof(t)==="object"){S.local_data=t}}if(S.classes){S.classes=e.extend({},f,S.classes)}else{if(S.theme){S.classes={};e.each(f,function(X,Y){S.classes[X]=Y+"-"+S.theme})}else{S.classes=f}}var F=[];var w=0;var s=new e.TokenList.Cache();var Q;var N;var A=e('<input type="text"  autocomplete="off">').css({outline:"none"}).attr("id",S.idPrefix+j.id).focus(function(){if(S.tokenLimit===null||S.tokenLimit!==w){m()}}).blur(function(){G()}).bind("keyup keydown blur update",h).keydown(function(Z){var ab;var X;switch(Z.keyCode){case a.DOWN:if(!e(this).val()){ab=o.prev();X=o.next();if((ab.length&&ab.get(0)===D)||(X.length&&X.get(0)===D)){if(Z.keyCode===a.LEFT||Z.keyCode===a.UP){K(e(D),d.BEFORE)}else{K(e(D),d.AFTER)}}else{if((Z.keyCode===a.LEFT||Z.keyCode===a.UP)&&ab.length){T(e(ab.get(0)))}else{if((Z.keyCode===a.RIGHT||Z.keyCode===a.DOWN)&&X.length){T(e(X.get(0)))}}}}else{var aa=null;if(Z.keyCode===a.DOWN||Z.keyCode===a.RIGHT){aa=e(P).next()}else{aa=e(P).prev()}if(aa.length){W(aa)}return false}break;case a.BACKSPACE:ab=o.prev();var ac=J(this);var Y=g(this);if(!e(this).val().length||(ac==0&&Y.length==0)){if(D){l(e(D));E.change()}else{if(ab.length){T(e(ab.get(0)))}}return false}else{if(e(this).val().length===1){G()}else{setTimeout(function(){C()},5)}}break;case a.TAB:case a.ENTER:case a.NUMPAD_ENTER:case a.COMMA:if(P){M(e(P).data("tokeninput"));E.change();return false}break;case a.ESCAPE:G();return true;default:if(String.fromCharCode(Z.which)){setTimeout(function(){C()},5)}break}});var E=e(j).hide().val("").focus(function(){A.focus()}).blur(function(){A.blur()});var D=null;var H=0;var P=null;var q=e("<ul />").addClass(S.classes.tokenList).click(function(Y){var X=e(Y.target).closest("li");if(X&&X.get(0)&&e.data(X.get(0),"tokeninput")){}else{if(D){K(e(D),d.END)}A.focus()}}).mouseover(function(Y){var X=e(Y.target).closest("li");if(X&&D!==this){X.addClass(S.classes.highlightedToken)}}).mouseout(function(Y){var X=e(Y.target).closest("li");if(X&&D!==this){X.removeClass(S.classes.highlightedToken)}}).insertBefore(E);var o=e("<li />").addClass(S.classes.inputToken).appendTo(q).append(A);var U=e("<div>").addClass(S.classes.dropdown).appendTo("body").hide();var L=e("<tester/>").insertAfter(A).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:A.css("fontSize"),fontFamily:A.css("fontFamily"),fontWeight:A.css("fontWeight"),letterSpacing:A.css("letterSpacing"),whiteSpace:"nowrap"});E.val("");var z=S.prePopulate||E.data("pre");if(S.processPrePopulate&&e.isFunction(S.onResult)){z=S.onResult.call(E,z)}if(z&&z.length){e.each(z,function(X,Y){k(Y);I()})}if(e.isFunction(S.onReady)){S.onReady.call()}this.clear=function(){q.children("li").each(function(){if(e(this).children("input").length===0){l(e(this))}})};this.add=function(X){M(X)};this.remove=function(X){q.children("li").each(function(){if(e(this).children("input").length===0){var aa=e(this).data("tokeninput");var Y=true;for(var Z in X){if(X[Z]!==aa[Z]){Y=false;break}}if(Y){l(e(this))}}})};this.getTokens=function(){return F};function g(X){var Z="";if(document.selection){var ab=document.selection.createRange();Z=ab.text}else{var aa=X.selectionStart;var Y=X.selectionEnd;Z=X.value.substring(aa,Y)}return Z}function J(X){if(/msie/.test(navigator.userAgent.toLowerCase())){var Z=document.selection.createRange();var aa=X.createTextRange();aa.collapse(true);aa.select();var Y=document.selection.createRange();Y.setEndPoint("EndToEnd",Z);var ab=Y.text.length;Z.select();return ab}else{return X.selectionStart}}function I(){if(S.tokenLimit!==null&&w>=S.tokenLimit){A.hide();G();return}}function h(){if(N===(N=A.val())){return}var X=N.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");L.html(X)}function R(X){return((X>=48&&X<=90)||(X>=96&&X<=111)||(X>=186&&X<=192)||(X>=219&&X<=222))}function k(X){var Z=S.tokenFormatter(X);Z=e(Z).addClass(S.classes.token).insertBefore(o);e("<span>"+S.deleteText+"</span>").addClass(S.classes.tokenDelete).appendTo(Z).click(function(){l(e(this).parent());E.change();return false});var Y={id:X.id};Y[S.propertyToSearch]=X[S.propertyToSearch];e.data(Z.get(0),"tokeninput",X);F=F.slice(0,H).concat([Y]).concat(F.slice(H));H++;x(F,E);w+=1;if(S.tokenLimit!==null&&w>=S.tokenLimit){A.hide();G()}return Z}function M(X){var Z=S.onAdd;if(w>0&&S.preventDuplicates){var Y=null;q.children().each(function(){var ab=e(this);var aa=e.data(ab.get(0),"tokeninput");if(aa&&aa.id===X.id){Y=ab;return false}});if(Y){T(Y);o.insertAfter(Y);A.focus();return}}if(S.tokenLimit==null||w<S.tokenLimit){k(X);I()}A.val("");G();if(e.isFunction(Z)){Z.call(E,X)}}function T(X){X.addClass(S.classes.selectedToken);D=X.get(0);G()}function K(Y,X){Y.removeClass(S.classes.selectedToken);D=null;if(X===d.BEFORE){o.insertBefore(Y);H--}else{if(X===d.AFTER){o.insertAfter(Y);H++}else{o.appendTo(q);H=w}}A.focus()}function V(Y){var X=D;if(D){K(e(D),d.END)}if(X===Y.get(0)){K(Y,d.END)}else{T(Y)}}function l(Y){var Z=e.data(Y.get(0),"tokeninput");var aa=S.onDelete;var X=Y.prevAll().length;if(X>H){X--}Y.remove();D=null;A.focus();F=F.slice(0,X).concat(F.slice(X+1));if(X<H){H--}x(F,E);w-=1;if(S.tokenLimit!==null){A.show().val("").focus()}if(e.isFunction(aa)){aa.call(E,Z)}}function x(Z,X){var Y=e.map(Z,function(aa){return aa[S.tokenValue]});X.val(Y.join(S.tokenDelimiter))}function G(){U.hide().empty();P=null}function r(){U.css({position:"absolute",top:e(q).offset().top+e(q).outerHeight(),left:e(q).offset().left,zindex:999}).show()}function p(){if(S.searchingText){U.html("<p>"+S.searchingText+"</p>");r()}}function m(){if(S.hintText){U.html("<p>"+S.hintText+"</p>");r()}}function v(Y,X){return Y.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+X+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")}function B(Y,Z,X){return Y.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+Z+")(?![^<>]*>)(?![^&;]+;)","g"),v(Z,X))}function O(Z,X){if(X&&X.length){U.empty();var Y=e("<ul>").appendTo(U).mouseover(function(aa){W(e(aa.target).closest("li"))}).mousedown(function(aa){M(e(aa.target).closest("li").data("tokeninput"));E.change();return false}).hide();e.each(X,function(aa,ab){var ac=S.resultsFormatter(ab);ac=B(ac,ab[S.propertyToSearch],Z);ac=e(ac).appendTo(Y);if(aa%2){ac.addClass(S.classes.dropdownItem)}else{ac.addClass(S.classes.dropdownItem2)}if(aa===0){W(ac)}e.data(ac.get(0),"tokeninput",ab)});r();if(S.animateDropdown){Y.slideDown("fast")}else{Y.show()}}else{if(S.noResultsText){U.html("<p>"+S.noResultsText+"</p>");r()}}}function W(X){if(X){if(P){i(e(P))}X.addClass(S.classes.selectedDropdownItem);P=X.get(0)}}function i(X){X.removeClass(S.classes.selectedDropdownItem);P=null}function C(){var X=A.val().toLowerCase();if(X&&X.length){if(D){K(e(D),d.AFTER)}if(X.length>=S.minChars){p();clearTimeout(Q);Q=setTimeout(function(){u(X)},S.searchDelay)}else{G()}}}function u(ad){var Z=ad+y();var X=s.get(Z);if(X){O(ad,X)}else{if(S.url){var ab=y();var aa={};aa.data={};if(ab.indexOf("?")>-1){var ae=ab.split("?");aa.url=ae[0];var Y=ae[1].split("&");e.each(Y,function(af,ah){var ag=ah.split("=");aa.data[ag[0]]=ag[1]})}else{aa.url=ab}aa.data[S.queryParam]=ad;aa.type=S.method;aa.dataType=S.contentType;if(S.crossDomain){aa.dataType="jsonp"}aa.success=function(af){if(e.isFunction(S.onResult)){af=S.onResult.call(E,af)}s.add(Z,S.jsonContainer?af[S.jsonContainer]:af);if(A.val().toLowerCase()===ad){O(ad,S.jsonContainer?af[S.jsonContainer]:af)}};e.ajax(aa)}else{if(S.local_data){var ac=e.grep(S.local_data,function(af){return af[S.propertyToSearch].toLowerCase().indexOf(ad.toLowerCase())>-1});if(e.isFunction(S.onResult)){ac=S.onResult.call(E,ac)}s.add(Z,ac);O(ad,ac)}}}}function y(){var X=S.url;if(typeof S.url=="function"){X=S.url.call()}return X}};e.TokenList.Cache=function(h){var j=e.extend({max_size:500},h);var k={};var i=0;var g=function(){k={};i=0};this.add=function(m,l){if(i>j.max_size){g()}if(!k[m]){i+=1}k[m]=l};this.get=function(l){return k[l]}}}(jQuery));